# Telegram Bot для отслеживания наличных денежных средств

Бот для прозрачного отслеживания движения наличных денежных средств от менеджера через ассистента к собственнику, с интеграцией Google Sheets.

## Требования

- Python 3.8+
- Google Service Account ключ (JSON файл)
- Telegram Bot Token
- Доступ к Google Sheets

## Установка

1. Клонируйте репозиторий или скачайте файлы проекта

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

3. Настройте конфигурацию в `config.py`:
   - `TELEGRAM_BOT_TOKEN` - токен бота от BotFather
   - `GOOGLE_SHEETS_ID` - ID Google таблицы
   - `GOOGLE_SERVICE_ACCOUNT_FILE` - путь к JSON файлу с credentials

## Настройка Google Sheets

1. **Предоставьте доступ Service Account к таблице:**
   - Откройте вашу Google таблицу
   - Нажмите "Настроить доступ" (Share)
   - Добавьте email из Service Account (указан в JSON файле, поле `client_email`)
   - Дайте права "Редактор" (Editor)

2. **Структура таблицы:**
   
   **Основной лист** (название: "Ответы на форму (1)"):
   - Заполняется через Google Form
   - Колонки:
     - Отметка времени
     - Представьтесь (имя менеджера)
     - Канал с которого пришел клиент
     - чей объект
     - Локация
     - Договор купли-продажи
     - № ММ/квартиры/участка
     - Дата поступления ДС
     - Реальная цена продажи
     - Цена продажи в ДКП
     - Вся сумма по безналу?
     - Кто получил нал?
     - В какой сумме получен нал
     - Передано ассистенту? (Да/Нет)
     - Передано собственнику? (Да/Нет)
     - Собственник принял? (Да/Нет)
     - Сумма принято наличных
     - Разница получено-принято
   - Ключ сделки (DealID) формируется автоматически как: `<чей объект>/<Локация>/<№ ММ/квартиры/участка>`
   
   **Лист ролей** (название: "Роли", опционально):
   - Если лист не существует, роли будут NULL для всех пользователей
   - Рекомендуемая структура: ФИО, Telegram ID, Роль
   - Роли: "Менеджер", "Ассистент", "Собственник"
   - Можно создать вручную для настройки ролей пользователей
   
   **Лист журнала** (название: "CashFlow_Log"):
   - Создается автоматически при первом запуске
   - Колонки: DealID, Этап, Роль, Пользователь, Сумма, Timestamp
   - Используется для аудита всех операций с наличными

## Запуск

```bash
python main.py
```

Бот запустится в режиме polling (опрос сервера Telegram).

## Использование

1. Пользователь отправляет команду `/start` боту
2. Бот определяет роль пользователя из таблицы ролей
3. Пользователь может просмотреть свои сделки командой `/my_deals`
4. Для каждой сделки можно:
   - Просмотреть детали
   - Подтвердить этап передачи денег
   - Ввести сумму
   - Просмотреть историю операций

## Этапы движения наличных

1. Получено менеджером
2. Передано ассистенту
3. Принято ассистентом
4. Передано собственнику
5. Принято собственником (финал)

## Особенности

- **Прозрачность**: Все операции записываются в журнал CashFlow_Log
- **Аудит**: Каждое событие имеет timestamp и информацию о пользователе
- **Расхождения**: Автоматический расчет расхождений между суммами
- **Идемпотентность**: Защита от дублирования событий
- **Валидация**: Проверка сумм и формата данных

## Структура проекта

```
Bot_for_Avans_otcheti/
├── main.py                 # Точка входа
├── config.py               # Конфигурация
├── requirements.txt        # Зависимости
├── bot/                    # Модуль Telegram бота
│   ├── handlers.py        # Обработчики команд
│   ├── keyboards.py       # Клавиатуры
│   ├── messages.py        # Шаблоны сообщений
│   └── notifications.py   # Уведомления
├── sheets/                 # Модуль Google Sheets
│   ├── client.py          # Клиент API
│   ├── models.py          # Модели данных
│   └── operations.py      # Операции с данными
├── business/               # Бизнес-логика
│   ├── roles.py           # Логика ролей
│   ├── cashflow.py        # Логика движения наличных
│   └── validators.py      # Валидация
└── utils/                  # Утилиты
    └── helpers.py
```

## Troubleshooting

### Ошибка доступа к Google Sheets
- Проверьте, что Service Account имеет доступ к таблице
- Убедитесь, что email из `client_email` добавлен в список доступа

### Бот не отвечает
- Проверьте правильность Telegram Bot Token
- Убедитесь, что бот запущен (`python main.py`)
- Проверьте логи на наличие ошибок

### Пользователь не видит сделки
- Проверьте, что роль пользователя назначена в таблице "Роли"
- Убедитесь, что Telegram ID указан правильно

## Разработка

Для разработки рекомендуется использовать виртуальное окружение:

```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
# или
venv\Scripts\activate  # Windows

pip install -r requirements.txt
```

## Лицензия

Проект создан для внутреннего использования.

